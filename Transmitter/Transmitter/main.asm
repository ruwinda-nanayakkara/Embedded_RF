;
; Transmitter.asm
;
; Created: 2/13/2023 5:59:56 PM
; Author : Ruwinda Nanayakkara
;

.include "m328pdef.inc"

.ORG 0					;location for reset
	JMP	MAIN
.ORG 0x02				;location for external interrupt 0
	JMP	EX0_ISR	
.ORG 0x04
	JMP EX1_ISR
		

MAIN:	LDI R20,HIGH(RAMEND)	; Initalizing the stack
	OUT SPH,R20
	LDI R20,LOW(RAMEND)
	OUT SPL,R20
	SBI DDRB,3
	SBI DDRB,4
	CBI DDRD,2
	CBI DDRD,3
	LDI	R20,0x00		;make INT0 low level triggered
	STS	EICRA,R20		
	LDI R20,1<<PD2 | 1<<PD3 ;Pull up register enable PORTD
	OUT PORTD,R20
	LDI	R20,1<<INT0 | 1<<INT1		;enable INT0 and INT1
	OUT	EIMSK,R20
	SEI

XX:	SBI PORTB,3
	RCALL DELAY
	CBI PORTB,3
	RCALL DELAY
	RJMP XX

DELAY:	LDI R16,0
		OUT TCNT0,R16
		LDI R20,0xBC
		OUT OCR0A,R20
		LDI R20,0x02
		OUT TCCR0A,R20
		LDI R20,0x04
		OUT TCCR0B,R20
AGAIN:	IN R20,TIFR0
		SBRS R20,OCF0A
		RJMP AGAIN
		LDI R20,0x00
		OUT TCCR0A,R20
		LDI R20,(0<<OCF0A)
		OUT TIFR0,R20
		RET

EX0_ISR:
loop0:	SBI PORTB,3
		RCALL DELAY0
		CBI PORTB,3
		RCALL DELAY0
		IN R20,PIND
		SBRS R20,PD2
		RJMP loop0
		RETI

EX1_ISR:
loop1:	SBI PORTB,3
		RCALL DELAY1
		CBI PORTB,3
		RCALL DELAY1
		IN R20,PIND
		SBRS R20,PD3
		RJMP loop1
		RETI


DELAY0:	LDI R16,0
		OUT TCNT0,R16
		LDI R20,0x5F
		OUT OCR0A,R20
		LDI R20,0x02
		OUT TCCR0A,R20
		LDI R20,0x04
		OUT TCCR0B,R20
AGAIN0:	IN R20,TIFR0
		SBRS R20,OCF0A
		RJMP AGAIN0
		LDI R20,0x00
		OUT TCCR0A,R20
		LDI R20,(0<<OCF0A)
		OUT TIFR0,R20
		RET

DELAY1:	LDI R16,0
		OUT TCNT0,R16
		LDI R20,0x3E
		OUT OCR0A,R20
		LDI R20,0x02
		OUT TCCR0A,R20
		LDI R20,0x04
		OUT TCCR0B,R20
AGAIN1:	IN R20,TIFR0
		SBRS R20,OCF0A
		RJMP AGAIN1
		LDI R20,0x00
		OUT TCCR0A,R20
		LDI R20,(0<<OCF0A)
		OUT TIFR0,R20
		RET